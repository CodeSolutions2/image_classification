<!DOCTYPE html>
<html>
<head></head>
<body>
	
  <h1 style='text-align: center; margin-bottom: -35px;'>CodeSolution2 - Image labeling webapp: Read files from URL and output label</h1>
  <br><br>


<div id="output" style="font-family:courier;font-size:24px;height:300px"></div>


  
  
<style>canvas {border: 1px solid black;}</style>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@1.0.0"></script>

<script>

  // -------------------------------------------------
	
  const outp = document.getElementById('output');

  // -------------------------------------------------
	
async function runit() {
	
  try {
    // Way 0
    // const fs = requestFileSystemSync(window.TEMPORARY, 1024 * 1024 /*1MB*/);
    // getAllEntries(fs.root.createReader());

    // Way 1
    // const directory = "https:github.com/CodeSolutions2/test_4_webapps";
    // var entries = readDirectory(directory);
    // for (var i=0; i<entries.length; i++){
    //		  outp.innerHTML += "<br/>" + entries[i];
    //}
    // TypeError: directory.createReader is not a function

    // Way 2
    const repoOwner = 'CodeSolutions2';
    const repoName = 'test_4_webapps';
    var url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents`;
    //var options = {method : 'get', headers: headers, mode: 'no-cors'};
    await fetch(url).then(res => res.json()).then(data => {

    data.forEach(file => {
      if (file.type === 'file' && file.name.match(/.(jpg|jpeg|png|gif)$/i)) {
        
        outp.innerHTML += "Filename=" + file.name + ", file url=" + file.download_url + "<br/>";

	// Create a canvas element
	var canvasElement = document.createElement('canvas');

	// Set the width and height of the canvas
	canvasElement.width = 224;
	canvasElement.height = canvasElement.width;
	      
	// Get the 2D rendering context of the canvas
	const ctx = canvasElement.getContext("2d");
	      
	// Add the canvas to the document body or any other desired element
	document.body.appendChild(canvasElement);

	const image = new Image();

	image.src = file.download_url;

	image.onload = function async (){
		      
	        // Draw image on canvas
	        canvasElement.style.display = "block";
	        ctx.drawImage(image, 0,0);
		      
	        // Convert the image element to a tensor using fromPixels
	        var tensor_image = tf.browser.fromPixels(image); // This is size 224,224,3
		outp.innerHTML = tf.max(tensor_image);
			
	        const eTensor = tensor_image.expandDims(0); // This is size 1,224,224,3
		      
	        // Give image to model
	        await mobilenet.load().then(model => {model.classify(eTensor).then(predictions => {for(var i = 0; i<predictions.length; i++){outp.innerHTML += "<br/>" + predictions[i].className + " : " + predictions[i].probability;} }); });
			
      };  // end of image.onload

      }
    });
  })
  .catch(error => {
    outp.innerHTML += error;
  });


	  
  } catch (error) {
    outp.innerHTML = error;
  }

}
runit();

  // -------------------------------------------------


</script>
</body>
</html>
